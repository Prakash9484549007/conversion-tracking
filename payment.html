<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Checkout</title>
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .checkout-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        h1 { color: #333; margin-bottom: 5px; }
        .amount { font-size: 32px; color: #4CAF50; font-weight: 700; margin: 20px 0; }
        .pay-btn { background: #333; color: white; border: none; padding: 12px 30px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; transition: 0.3s; }
        .pay-btn:hover { background: #555; }
        .back-link { display: block; margin-top: 15px; color: #777; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

    <div class="checkout-box">
        <h1>Confirm Payment</h1>
        <p>Complete your purchase securely.</p>
        
        <div class="amount" id="display-amt">₹0</div>
        
        <button id="rzp-button" class="pay-btn">Pay Now</button>
        <a href="shop.html" class="back-link">Cancel</a>
    </div>

    <script>
        // 1. Get Amount from URL
        const urlParams = new URLSearchParams(window.location.search);
        const totalAmount = urlParams.get('total') || 1; // Default 1 Rupee if missing
        document.getElementById('display-amt').innerText = "₹" + totalAmount;

        // 2. Button Click Handler
        document.getElementById('rzp-button').onclick = async function (e) {
            const btn = document.getElementById('rzp-button');
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                // A. Ask Backend to create an Order ID
                // REPLACE WITH YOUR RENDER URL
                const response = await fetch('https://shop-backend-0b4p.onrender.com/api/payment/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: totalAmount }) 
                });
                
                const data = await response.json();

                if (!data.success) {
                    alert("Order Creation Failed. Check console.");
                    console.error(data);
                    btn.disabled = false;
                    return;
                }

                // B. Open Razorpay Popup
                const options = {
                    "key": "rzp_test_RmfKScXAi9Jpy4", // Paste Key ID here (Public one is safe)
                    "amount": data.order.amount,
                    "currency": "INR",
                    "name": "Conversion Shop",
                    "description": "Test Transaction",
                    "image": "https://cdn-icons-png.flaticon.com/512/4290/4290854.png", // Demo Logo
                    "order_id": data.order.id, // Comes from backend
                    "handler": function (response) {
                        // C. SUCCESS!
                        alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
                        
                        // Optional: Redirect to a 'Success' page or clear cart here
                        window.location.href = "shop.html"; 
                    },
                    "prefill": {
                        "name": "Guest User",
                        "email": "guest@example.com",
                        "contact": "9999999999"
                    },
                    "theme": {
                        "color": "#4CAF50"
                    }
                };

                const rzp1 = new Razorpay(options);
                rzp1.open();
                btn.innerText = "Pay Now";
                btn.disabled = false;

            } catch (err) {
                console.error(err);
                alert("Connection Error");
                btn.innerText = "Pay Now";
                btn.disabled = false;
            }
        };
    </script>

</body>
</html>