<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Conversion Tracking</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="auth.js"></script>
</head>
<body>

    <header class="site-header">
        <div class="site-branding">
            <span>Conversion</span> Tracking
        </div>
        <nav>
            <div class="dropdown">
                <button class="dropbtn">Contact Form 7 <i class="fa fa-caret-down"></i></button>
                <div class="dropdown-content">
                    <a href="index.html">Redirect Form</a>
                    <a href="ajax.html">AJAX Form</a>
                </div>
            </div> 
            <a href="wp-form.html">WP Form</a>
            <a href="fluent-form.html">Fluent Form</a>
            <a href="shop.html" class="active-link">E-Commerce Store</a>
            
            <div class="auth-container">
                <div id="user-profile" style="display:flex;">
                    <img id="user-pic" src="" alt="Profile">
                    
                    <div class="profile-info">
                        <span id="user-name"></span>
                        <button onclick="deleteAccount()" class="delete-btn">Delete Account</button>
                    </div>
                    
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <div style="position: fixed; bottom: 30px; right: 30px; display: flex; gap: 10px; z-index: 100;">
        <div onclick="openNav('wishlist-sidebar')" class="floating-cart" style="background: #e91e63; position: relative;">
            <i class="fa fa-heart"></i>
        </div>
        <div onclick="openNav('cart-sidebar')" class="floating-cart" style="position: relative;">
            <i class="fa fa-shopping-cart"></i>
            <div class="cart-count" id="cart-counter">0</div>
        </div>
    </div>

    <div class="shop-header">
        <h1>Our Products</h1>
        <p>Items added here are tracked in your local MongoDB Database.</p>
    </div>

    <div class="shop-container" id="product-grid"></div>

    <div id="cart-sidebar" class="sidebar">
        
        <div class="sidebar-header">
            <h2>Your Cart</h2> <button class="close-btn" onclick="closeNav('cart-sidebar')">&times;</button> </div>

        <div class="sidebar-content" id="cart-items-container">
            </div>

        <div class="sidebar-footer">
            <h3 style="margin: 0; color: #333;">Total: ₹<span id="cart-total">0</span></h3>
            <button id="checkout-btn" class="checkout-btn" onclick="goToCheckout()">Checkout Now</button>
        </div>
    </div>

    <div id="wishlist-sidebar" class="sidebar">
        
        <div class="sidebar-header">
            <h2>Your Wishlist</h2> <button class="close-btn" onclick="closeNav('wishlist-sidebar')">&times;</button> </div>

        <div class="sidebar-content" id="wishlist-items-container">
            </div>
        
    </div>

    <script>
        // 1. IDENTIFY THE USER
        // We trust auth.js has already checked this. If it's missing, auth.js kicks them out.
        let userId = localStorage.getItem('real_user_id'); 
        console.log("Current User:", userId);
        console.log("Current User:", userId);

        let products = [];
        let cart = [];
        let wishlist = [];

        // 2. LOAD DATA
        async function loadData() {
            try {
                // 1. Fetch Products
                const resProd = await fetch('https://shop-backend-0b4p.onrender.com/api/products');
                products = await resProd.json();
                renderProducts(products);

                // 2. Fetch Old Cart from DB
                const resCart = await fetch(`https://shop-backend-0b4p.onrender.com/api/cart/${userId}`);
                cart = await resCart.json();
                updateCartUI();

                // 3. INITIALIZE WISHLIST UI (This fixes the missing message)
                // Even if we haven't fetched data, this forces the "Empty" message to show
                updateWishlistUI();

            } catch (err) {
                console.error("Error loading data. Is the backend server running?", err);
                document.getElementById('product-grid').innerHTML = "<p>Error connecting to database. Please run 'node server.js'.</p>";
            }
        }

        function renderProducts(list) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = "";
            list.forEach(p => {
                grid.innerHTML += `
                    <div class="product-card">
                        <img src="${p.img}" class="product-image">
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <div class="product-price">₹${p.price}</div>
                            <div class="product-actions">
                                <button class="btn-cart" onclick="addToCart(${p.id})">Add to Cart</button>
                                <button class="btn-wishlist" onclick="addToWishlist(${p.id})">
                                    <i class="fa fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
            
            // Track View Item List
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                event: 'view_item_list',
                ecommerce: { items: list.map(p => ({ item_id: p.id, item_name: p.name, price: p.price })) }
            });
        }

        // 3. CART LOGIC (With DB Sync)
        function addToCart(id) {
            const item = products.find(p => p.id === id);
            cart.push(item);
            updateCartUI();
            saveToDB('/api/cart', cart); // Sync to DB
            openNav('cart-sidebar'); // Auto open cart
            
            // Tracking
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                event: 'add_to_cart',
                ecommerce: { currency: 'INR', value: item.price, items: [{ item_id: item.id, item_name: item.name, price: item.price }] }
            });
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
            saveToDB('/api/cart', cart);
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            const counter = document.getElementById('cart-counter');
            const totalSpan = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn'); // Select the button

            // 1. Update Counter
            counter.innerText = cart.length;
            
            // 2. Render Items
            let total = 0;
            container.innerHTML = "";

            if (cart.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Your cart is empty.</p>";
                
                // DISABLE BUTTON
                checkoutBtn.disabled = true;
                checkoutBtn.style.backgroundColor = "#ccc"; // Turn Grey
                checkoutBtn.style.cursor = "not-allowed";
                checkoutBtn.innerText = "Cart is Empty";
            } else {
                // ENABLE BUTTON
                checkoutBtn.disabled = false;
                checkoutBtn.style.backgroundColor = "#4CAF50"; // Turn Green
                checkoutBtn.style.cursor = "pointer";
                checkoutBtn.innerText = "Checkout Now";

                // Loop through items
                cart.forEach((item, index) => {
                    total += item.price;
                    container.innerHTML += `
                        <div class="cart-item">
                            <div>
                                <strong>${item.name}</strong><br>₹${item.price}
                            </div>
                            <span class="item-remove" onclick="removeFromCart(${index})">Remove</span>
                        </div>`;
                });
            }

            // 3. Update Total Text
            totalSpan.innerText = total;
        }

        // 4. WISHLIST LOGIC (With DB Sync)
        function addToWishlist(id) {
            const item = products.find(p => p.id === id);
            // Check if already in wishlist
            if(!wishlist.some(w => w.id === id)) {
                wishlist.push(item);
                updateWishlistUI();
                saveToDB('/api/wishlist', wishlist);
                alert("Added to Wishlist");
                
                // Tracking
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    event: 'add_to_wishlist',
                    ecommerce: { currency: 'INR', value: item.price, items: [{ item_id: item.id, item_name: item.name, price: item.price }] }
                });
            }
        }

        function removeFromWishlist(index) {
            wishlist.splice(index, 1);
            updateWishlistUI();
            saveToDB('/api/wishlist', wishlist);
        }

        function updateWishlistUI() {
            const container = document.getElementById('wishlist-items-container');
            container.innerHTML = ""; // Clear current list

            // CHECK IF EMPTY
            if (wishlist.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Your wishlist is empty.</p>";
            } else {
                // RENDER ITEMS
                wishlist.forEach((item, index) => {
                    container.innerHTML += `
                        <div class="cart-item">
                            <div>
                                <strong>${item.name}</strong><br>
                                <span style="font-size:12px; color:#666;">₹${item.price}</span>
                            </div>
                            <div>
                                <button onclick="moveWishlistToCart(${index}, ${item.id})" style="background:none; border:none; color:#4CAF50; cursor:pointer; margin-right:10px; font-size:18px;" title="Move to Cart">
                                    <i class="fa fa-shopping-cart"></i>
                                </button>
                                <span class="item-remove" onclick="removeFromWishlist(${index})">Remove</span>
                            </div>
                        </div>`;
                });
            }
        }

        function moveWishlistToCart(index, id) {
            addToCart(id);       // Add to Cart
            removeFromWishlist(index); // Remove from Wishlist
        }

        // 5. HELPER: SAVE TO DB
        async function saveToDB(endpoint, items) {
            try {
                    await fetch(`https://shop-backend-0b4p.onrender.com${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, items: items })
                });
                console.log("Synced to DB:", endpoint);
            } catch(e) {
                console.error("DB Sync Failed", e);
            }
        }

        // 6. NAVIGATION
        // 6. NAVIGATION (Responsive)
        function openNav(id) { 
            // If screen is small (mobile), take 100% width. Otherwise 350px.
            if (window.innerWidth <= 600) {
                document.getElementById(id).style.width = "100%";
            } else {
                document.getElementById(id).style.width = "350px";
            }
        }
        
        function closeNav(id) { 
            document.getElementById(id).style.width = "0"; 
        }
        
        function goToCheckout() {
            const total = document.getElementById('cart-total').innerText;
            window.location.href = `payment.html?total=${total}`;
        }

        // Init
        loadData();
        // ==========================================
    </script>

</body>
</html>